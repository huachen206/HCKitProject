//
//  HCBaseTable.m
//  Lottery
//
//  Created by 花晨 on 15/8/29.
//  Copyright (c) 2015年 花晨. All rights reserved.
//

#import "HCBaseTable.h"

@interface HCBaseTable()
@property (nonatomic,strong) NSMutableArray *elements;
@end

@implementation HCBaseTable
+(instancetype)table{
    NSAssert(NO, @"override me");
    return nil;
}

-(id)init{
    if (self = [super init]) {
        self.typeNames = [[NSMutableArray alloc] init];
        self.columnNames = [[NSMutableArray alloc] init];
        self.elements = [[NSMutableArray alloc] init];
    }
    return self;
}
-(id)initWithTableName:(NSString *)tableName typeNames:(NSArray *)typeNames columnNames:(NSArray *)columnNames{
    if (self = [super init]) {
        self.tableName = tableName;
        self.typeNames = [[NSMutableArray alloc] initWithArray:typeNames];
        self.columnNames = [[NSMutableArray alloc] initWithArray:columnNames];
        self.elements = [[NSMutableArray alloc] init];

    }
    return self;
}
-(void)addTypeName:(NSString *)typeName columnName:(NSString *)columnName{
    [self.typeNames addObject:typeName];
    [self.columnNames addObject:columnName];
    NSString *tmpStr = [NSString stringWithFormat:@"%@ %@",columnName,typeName];
    [self.elements addObject:tmpStr];
    
}
-(NSString*)primaryColumnName{
    for (int i=0; i<self.typeNames.count; i++) {
        NSString *typeName = self.typeNames[i];
        if ([typeName containsString:@"PRIMARY KEY"]) {
            return [self.columnNames objectAtIndex:i];
        }
    }
    return nil;
}

#pragma mark creat upgrade
-(BOOL)creatOrUpgradeTable{
    __block BOOL flag = NO;
    NSString *creatSql = [self creatString];
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        flag = [db executeUpdate:creatSql];
    }];
    PADBQuickCheck(flag);
    if (flag) {
        flag = [self upgradeTable];
    }
    return flag;
    
}
-(BOOL)upgradeTable{
    __block BOOL flag = YES;
    
    NSArray *adds = [self objectIn:self.columnNames withOut:[self getTableFields]];
    NSArray *drops = [self objectIn:[self getTableFields] withOut:self.columnNames];
    
    [self.fmDbQueue inTransaction:^(FMDatabase *db, BOOL *rollback) {
        for (NSString *column in adds) {
            NSString *type =self.typeNames[[self.columnNames indexOfObject:column]];
            NSString *addSql = [NSString stringWithFormat:@"ALTER TABLE %@ ADD COLUMN %@ %@",[self tableName],column,type];
            flag = flag&&[db executeUpdate:addSql];
        }
        
        //        for (NSString *field in drops) {
        //            NSString *dropSql = [NSString stringWithFormat:@"ALTER TABLE %@ DROP COLUMN %@",[self tableName],field];
        //            flag = flag&&[db executeUpdate:dropSql];
        //        }
        if (drops.count>0) {
            DebugAssert(NO, @"少定义字段");
        }
        
        PADBTransactionSQLCheck(flag,rollback);
        
    }];
    
    return flag;
    
}
#pragma mark read
-(NSArray *)selectAll{
    __block NSMutableArray *models = [NSMutableArray array];
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        FMResultSet *rs = [db selectResultsFrom:self.tableName orderBy:nil error:nil];
        while ([rs next]) {
            if (self.tableModelClass) {
                NSObject *model = [[self.tableModelClass alloc] initWithFMResultSet:rs columns:self.columnNames];

                [models addObject:model];
            }
        }
        [rs close];
    }];
    return models;
}

-(NSInteger)countOfRecord{
    __block NSInteger count;
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        FMResultSet *results = [db executeQuery:[NSString stringWithFormat:@"SELECT count(*) FROM %@",self.tableName]];
        if (results == nil)
        {
            count = -1;
        }
        else if ([results next])
        {
            if (sizeof(NSInteger) == sizeof(long))
            {
                count = [results longForColumnIndex:0];
            }
            else
            {
                count = [results intForColumnIndex:0];
            }
        }
        else
        {
            count = 0;
        }
        [results close];
    }];
    return count;
}

#pragma mark insert or replace
-(NSDictionary *)valueAndColumnWithModel:(NSObject *)baseModel{
    NSDictionary *dic = [baseModel properties_aps];
    
    NSArray *columnNames =self.columnNames;
    
    NSArray *both = [self objectIn:dic.allKeys andIn:columnNames];
    NSMutableDictionary *mdic = [NSMutableDictionary dictionary];
    for (NSString *columnName in both) {
        [mdic setObject:[dic objectForKey:columnName] forKey:columnName];
    }
    return dic;
}
-(NSDictionary *)removePrimaryKey:(NSDictionary *)mdic{
    NSMutableDictionary *dic = [NSMutableDictionary dictionaryWithDictionary:mdic];
    for (int i = 0; i<self.typeNames.count; i++) {
        NSString *typeName = self.typeNames[i];
        if ([typeName containsString:@"PRIMARY KEY AUTOINCREMENT"]) {
            NSString *columnName = self.columnNames[i];
            [dic removeObjectForKey:columnName];
        }
    }
    return dic;
}

-(BOOL)insertWithModel:(NSObject*)baseModel{
    return [self insertWithModel:baseModel isIgnorePrimaryKey:NO];
}
-(BOOL)insertWithModel:(NSObject*)baseModel isIgnorePrimaryKey:(BOOL)isIgnore{
    __block BOOL flag;
    NSDictionary *mdic;
    if (isIgnore) {
        mdic = [self removePrimaryKey:[self valueAndColumnWithModel:baseModel]];
    }else{
        mdic = [self valueAndColumnWithModel:baseModel];
    }
    NSString *sql = [self createInsertSqlByDictionary:mdic tablename:self.tableName];
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        flag = [db executeUpdate:sql withParameterDictionary:mdic];
    }];
    return flag;
}

-(BOOL)insertOrReplaceWithModel:(NSObject *)baseModel isIgnorePrimaryKey:(BOOL)isIgnore{
    __block BOOL flag;
    NSDictionary *mdic;
    if (isIgnore) {
        mdic = [self removePrimaryKey:[self valueAndColumnWithModel:baseModel]];
    }else{
        mdic = [self valueAndColumnWithModel:baseModel];
    }
    NSString *sql = [self createInsertOrReplaceSqlByDictionary:mdic tablename:self.tableName];
    
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        flag = [db executeUpdate:sql withParameterDictionary:mdic];
    }];
    return flag;
}
-(BOOL)insertOrReplaceWithModel:(NSObject *)baseModel{
    return [self insertOrReplaceWithModel:baseModel isIgnorePrimaryKey:NO];
}

-(BOOL)insertOrReplaceWithModelList:(NSArray *)modelList{
    return [self insertOrReplaceWithModelList:modelList isIgnorePrimaryKey:NO];
}
-(BOOL)insertOrReplaceWithModelList:(NSArray *)modelList  isIgnorePrimaryKey:(BOOL)isIgnore{
    __block BOOL flag = YES;
    [self.fmDbQueue inTransaction:^(FMDatabase *db, BOOL *rollback) {
        for (NSObject *model in modelList) {
            NSDictionary *mdic;
            if (isIgnore) {
                mdic = [self removePrimaryKey:[self valueAndColumnWithModel:model]];
            }else{
                mdic = [self valueAndColumnWithModel:model];
            }
            NSString *sql = [self createInsertOrReplaceSqlByDictionary:mdic tablename:self.tableName];
            flag = flag&&[db executeUpdate:sql withParameterDictionary:mdic];
        }
    }];
    return flag;

}

#pragma mark delete
-(BOOL)deleteWithModel:(id)model{
    //以primarykey删除
    if (!self.primaryColumnName) {
        NSAssert(NO, @"没有设置主键，无法删除");
        return NO;
    }
    id value = [model valueForKey:self.primaryColumnName];
    if (!value) {
        NSAssert(NO, @"主键无值，无法删除");
        return NO;
    }
    __block BOOL flag = NO;
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        NSString *sqlstr = [NSString stringWithFormat:@"DELETE FROM %@ WHERE %@ = %@",[self tableName],self.primaryColumnName,value];
        flag = [db executeUpdate:sqlstr];
        PADBQuickCheck(flag);
    }];
    return flag;
    
}




-(NSArray *)objectIn:(NSArray *)array1 andIn:(NSArray *)array2{
    NSPredicate * filterPredicate = [NSPredicate predicateWithFormat:@"(SELF IN %@)",array2];
    NSArray * filter = [array1 filteredArrayUsingPredicate:filterPredicate];
    return filter;
}


-(NSArray *)objectIn:(NSArray *)array1 withOut:(NSArray *)array2{
    NSPredicate * filterPredicate = [NSPredicate predicateWithFormat:@"NOT (SELF IN %@)",array2];
    NSArray * filter = [array1 filteredArrayUsingPredicate:filterPredicate];
    return filter;
}

-(NSArray *)getTableFields{
    NSString *sql = [NSString stringWithFormat:@"select * from %@ limit 1",self.tableName];
    
    NSMutableArray *array = [[NSMutableArray alloc] init];
    [self.fmDbQueue inDatabase:^(FMDatabase *db) {
        FMResultSet *rs = [db executeQuery:sql];
        for (int i = 0; i<rs.columnCount; i++) {
            [array addObject:[rs columnNameForIndex:i]];
        }
        [rs close];
    }];
    return array;
}




-(NSString *)creatString{
    NSString *creatTable = @"CREATE TABLE IF NOT EXISTS %@ ()";
    creatTable =[NSString stringWithFormat:creatTable,self.tableName];
    
    return [creatTable stringByReplacingOccurrencesOfString:@"()" withString:[NSString stringWithFormat:@"(%@)",[self holeElementString]]];
}
-(NSString *)createInsertSqlByDictionary:(NSDictionary *)dict tablename:(NSString *)table{
    return [self createSqlStrWithHeadString:@"insert into" Dictionary:dict tablename:table];

//    NSMutableString *sql = [[NSMutableString alloc] init];
//    [sql appendFormat:@"insert into %@ (",table] ;
//    NSInteger i = 0;
//    for (NSString *key in dict.allKeys) {
//        if (i>0) {
//            [sql appendString:@","];
//        }
//        [sql appendFormat:@"%@",key];
//        i++;
//    }
//    [sql appendString:@") values ("];
//    i = 0;
//    for (NSString *key in dict.allKeys) {
//        if (i>0) {
//            [sql appendString:@","];
//        }
//        [sql appendFormat:@":%@",key];
//        i++;
//    }
//    [sql appendString:@")"];
//    return sql;
}

-(NSString *)createInsertOrReplaceSqlByDictionary:(NSDictionary *)dict tablename:(NSString *)table{
    return [self createSqlStrWithHeadString:@"INSERT OR REPLACE INTO" Dictionary:dict tablename:table];
//    NSMutableString *sql = [[NSMutableString alloc] init];
//    [sql appendFormat:@"INSERT OR REPLACE INTO %@ (",table] ;
//    NSInteger i = 0;
//    for (NSString *key in dict.allKeys) {
//        if (i>0) {
//            [sql appendString:@","];
//        }
//        [sql appendFormat:@"%@",key];
//        i++;
//    }
//    [sql appendString:@") values ("];
//    i = 0;
//    for (NSString *key in dict.allKeys) {
//        if (i>0) {
//            [sql appendString:@","];
//        }
//        [sql appendFormat:@":%@",key];
//        i++;
//    }
//    [sql appendString:@")"];
//    return sql;
}
-(NSString *)createSqlStrWithHeadString:(NSString *)headString Dictionary:(NSDictionary *)dict tablename:(NSString *)table{
    NSMutableString *sql = [[NSMutableString alloc] init];
    [sql appendFormat:@"%@ %@ (",headString,table] ;
    NSInteger i = 0;
    for (NSString *key in dict.allKeys) {
        if (i>0) {
            [sql appendString:@","];
        }
        [sql appendFormat:@"%@",key];
        i++;
    }
    [sql appendString:@") values ("];
    i = 0;
    for (NSString *key in dict.allKeys) {
        if (i>0) {
            [sql appendString:@","];
        }
        [sql appendFormat:@":%@",key];
        i++;
    }
    [sql appendString:@")"];
    return sql;

}

-(NSString *)holeElementString{
    NSString *holeElementString = @"";
    for (NSString *elStr in self.elements) {
        if (holeElementString.length == 0) {
            holeElementString = elStr;
        }else{
            holeElementString = [[holeElementString stringByAppendingString:@","] stringByAppendingString:elStr];
        }
    }
    return holeElementString;
}
-(HCBaseDBHelper *)baseDBHelper{
    return self.DAO.baseDBHelper;
}

-(FMDatabaseQueue*)fmDbQueue{
    return self.DAO.fmDbQueue;
}

@end
